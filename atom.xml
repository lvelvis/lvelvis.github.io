<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://lvelvis.github.io</id>
    <title>lvelvis</title>
    <updated>2020-09-28T08:17:23.125Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="http://lvelvis.github.io"/>
    <link rel="self" href="http://lvelvis.github.io/atom.xml"/>
    <subtitle>æ—¶å…‰,æµ“æ·¡ç›¸å®œ;äººå¿ƒ,è¿œè¿‘ç›¸å®‰;è¿™å°±æ˜¯æœ€å¥½çš„ç”Ÿæ´»</subtitle>
    <logo>http://lvelvis.github.io/images/avatar.png</logo>
    <icon>http://lvelvis.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, lvelvis</rights>
    <entry>
        <title type="html"><![CDATA[kafkaæ¶ˆè´¹å‘½ä»¤]]></title>
        <id>http://lvelvis.github.io/post/kafka-xiao-fei-ming-ling/</id>
        <link href="http://lvelvis.github.io/post/kafka-xiao-fei-ming-ling/">
        </link>
        <updated>2020-09-28T08:12:09.000Z</updated>
        <content type="html"><![CDATA[<p>æ¨¡æ‹Ÿç”Ÿäº§æ¶ˆæ¯ï¼š</p>
<pre><code>bin/kafka-console-producer.sh --broker-list 192.168.101.100:9092 --topic flink-test
</code></pre>
<p>æ¨¡æ‹Ÿæ¶ˆè´¹æ•°æ®(ä»å¼€å§‹ä½ç½®æ¶ˆè´¹)</p>
<pre><code>bin/kafka-console-consumer.sh --bootstrap-server  192.168.101.100:9092  --topic flink-test --from-beginning  |head
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[logstash output file to HDFS]]></title>
        <id>http://lvelvis.github.io/post/logstash-output-file-to-hdfs/</id>
        <link href="http://lvelvis.github.io/post/logstash-output-file-to-hdfs/">
        </link>
        <updated>2020-09-04T02:45:33.000Z</updated>
        <content type="html"><![CDATA[<p>logstash ç›´æ¥æŠŠæ–‡ä»¶å†…å®¹å†™å…¥ hdfs ä¸­ï¼Œ å¹¶æ”¯æŒ hdfs å‹ç¼©æ ¼å¼ã€‚<br>
logstash éœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œwebhdfsæ’ä»¶ï¼Œé€šè¿‡hdfsçš„webæ¥å£å†™å…¥ã€‚<br>
å³ http://namenode00:50070/webhdfs/v1/ æ¥å£</p>
<p>æ–°ç‰ˆæœ¬logstashå·²é»˜è®¤å®‰è£…webhdfsæ’ä»¶<br>
å®˜ç½‘åœ°å€åŠä½¿ç”¨è¯´æ˜ï¼š<br>
https://www.elastic.co/guide/en/logstash/current/plugins-outputs-webhdfs.html<br>
æ£€æŸ¥hdfsçš„webhdsæ¥å£</p>
<pre><code>curl -i  &quot;http://namenode:50070/webhdfs/v1/?user.name=hadoop&amp;op=LISTSTATUS&quot;   
HTTP/1.1 200 OK
Cache-Control: no-cache
Expires: Thu, 13 Jul 2017 04:53:39 GMT
Date: Thu, 13 Jul 2017 04:53:39 GMT
Pragma: no-cache
Expires: Thu, 13 Jul 2017 04:53:39 GMT
Date: Thu, 13 Jul 2017 04:53:39 GMT
Pragma: no-cache
Content-Type: application/json
Set-Cookie: hadoop.auth=&quot;u=hadoop&amp;p=hadoop&amp;t=simple&amp;e=1499957619679&amp;s=KSxdSAtjXAllhn73vh1MAurG9Bk=&quot;; Path=/; Expires=Thu, 13-Jul-2017 14:53:39 GMT; HttpOnly
Transfer-Encoding: chunked
Server: Jetty(6.1.26)
æ³¨é‡Šï¼š active namenode è¿”å›æ˜¯200 ï¼Œstandby namenode è¿”å›æ˜¯403.
</code></pre>
<p>æµ‹è¯•hdfsæ˜¯å¦æ­£å¸¸é€šè®¯ï¼š</p>
<pre><code>#é€šè¿‡webhdfsæ¥å£åˆ›å»ºtest.conf
curl -i -X PUT &quot;http://hadoop-master:50070/webhdfs/v1/data/test.conf?user.name=hdfs&amp;op=CREATE&quot;
curl -i -T test.conf &quot;http://hadoop-slave1:50075/webhdfs/v1/data/test.conf?op=CREATE&amp;user.name=hdfs&amp;namenoderpcaddress=hadoop-master:9000&amp;overwrite=false&quot;
</code></pre>
<p>é…ç½®<br>
æ·»åŠ  logstash ä¸€ä¸ªé…ç½®æ–‡ä»¶</p>
<p>vim /home/mtime/logstash-2.3.1/conf/hdfs.conf</p>
<pre><code>input {
    kafka {
        bootstrap_servers =&gt; &quot;192.168.101.22:9092,192.168.101.23:9092,192.168.101.93:9092&quot;
        topics =&gt; &quot;test-logs&quot;
        group_id =&gt; &quot;hdfs-test-logs&quot;
        codec =&gt; json
	    consumer_threads =&gt; 15

    }
}

filter {
    date {
        match =&gt; [&quot;time&quot;,&quot;yyyy-MM-dd HH:mm:ss Z&quot;]
        target =&gt; &quot;@timestamp&quot;
        timezone =&gt; &quot;Asia/Shanghai&quot;
    }
    ruby {
        code =&gt; &quot;event.set('index.date', event.get('@timestamp').time.localtime.strftime('%Y%m%d'))&quot;
    }
    ruby {
        code =&gt; &quot;event.set('index.hour', event.get('@timestamp').time.localtime.strftime('%H'))&quot;
    }
}
output {            
    webhdfs {
           host =&gt; &quot;hadoop-master&quot;
           port =&gt; 50070
           path =&gt; &quot;/data/pt-collect-log/test-logs/%{index.date}/application-%{index.hour}.log&quot;
           user =&gt; &quot;hdfs&quot;
	   codec =&gt; line { format =&gt; &quot;%{message}&quot;}
           flush_size =&gt; 1000
           compression =&gt; &quot;gzip&quot;            
           idle_flush_time =&gt; 10
           retry_interval =&gt; 3
	   retry_times =&gt; 100
       }
}
</code></pre>
<p>å…³äºhdfséƒ¨åˆ†é…ç½®ï¼Œå¯ä»¥åœ¨ plugins-outputs-webhdfs å®˜ç½‘æ‰¾åˆ°<br>
å¯åŠ¨ logstart<br>
cd /home/mtime/logstash-2.3.1/bin/<br>
./logstash -f ../conf/hdfs.conf    # ä¸ºå‰å°å¯åŠ¨<br>
æŠ¥é”™å¤„ç†</p>
<pre><code>[WARN ][logstash.outputs.webhdfs ] Failed to flush outgoing items {:outgoing_count=&gt;160, :exception=&gt;&quot;WebHDFS::IOError&quot;,
æˆ‘å°†hdfsç«¯å£ ç”±åŸæ¥çš„50070 æ”¹ä¸º 14000 ç«¯å£ï¼Œå°±åœ¨ä¸æŠ¥é”™äº†ã€‚
å®˜æ–¹æä¾›çš„ä¾‹å­ä¸­ç”¨çš„å°±æ˜¯50070ç«¯å£ï¼Œä¸€ç›´æ²¡æœ‰å°è¯•14000ç«¯å£ã€‚

è¿˜æœ‰ï¼š
because this file lease is currently owned by DFSClient
hadoop ç§Ÿçº¦é—®é¢˜ï¼ŒåæœŸæ­£å¸¸å°±æ²¡æœ‰äº†ã€‚
æ‰§è¡ŒrecoverLeaseæ¥é‡Šæ”¾æ–‡ä»¶çš„é”

$ hdfs debug recoverLease -path /logstash/2017/02/10/go-03.log
è¿˜æœ‰ï¼š
:message=&gt;&quot;webhdfs write caused an exception: {\&quot;RemoteException\&quot;:{\&quot;message\&quot;:\&quot;Failed to APPEND_FILE
å½“ä¸€ä¸ªè¿›ç¨‹åœ¨è¯»å†™è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹åº”è¯¥æ˜¯ä¸èƒ½åŒæ—¶å†™å…¥çš„ã€‚
æˆ‘ä»¬ç”±åŸæ¥3ä¸ªlogstashåŒæ—¶æ¶ˆè´¹ï¼Œæ”¹ä¸ºäº†1ä¸ªlogstashæ¶ˆè´¹ï¼Œä¸åœ¨æŠ¥é”™äº†ã€‚
è¿™ä¸ªåº”è¯¥ä¹Ÿå¯ä»¥é€šè¿‡æœ‰è¯å†™å…¥hdfså‚æ•°æ¥è§£å†³ã€‚

è¿˜æœ‰ï¼š
Max write retries reached. Exception: initialize: name or service not known {:level=&gt;:error}
losgstash éœ€è¦èƒ½è§£ææ‰€æœ‰ hadoop é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„ä¸»æœºåã€‚
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[cephæŠ¥é”™ç®¡ç†]]></title>
        <id>http://lvelvis.github.io/post/ceph-bao-cuo-guan-li/</id>
        <link href="http://lvelvis.github.io/post/ceph-bao-cuo-guan-li/">
        </link>
        <updated>2020-08-25T10:12:33.000Z</updated>
        <content type="html"><![CDATA[<p>ä½¿ç”¨ceph -sæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼Œå‘ç°ä¸€ç›´æœ‰å¦‚ä¸‹æŠ¥é”™ï¼Œä¸”æ•°é‡ä¸€ç›´åœ¨å¢åŠ </p>
<pre><code>daemons have recently crashed
</code></pre>
<p>ç»æŸ¥å½“å‰ç³»ç»Ÿè¿è¡ŒçŠ¶æ€æ­£å¸¸ï¼Œåˆ¤æ–­è¿™é‡Œæ˜¾ç¤ºçš„åº”è¯¥æ˜¯å†å²æ•…éšœï¼Œå¤„ç†æ–¹å¼å¦‚ä¸‹ï¼š</p>
<p>æŸ¥çœ‹å†å²crash</p>
<pre><code>ceph crash ls-new
</code></pre>
<p>æ ¹æ®lså‡ºæ¥çš„idæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
<pre><code>ceph crash info &lt;crash-id&gt;
</code></pre>
<p>å°†å†å²crashä¿¡æ¯è¿›è¡Œå½’æ¡£ï¼Œå³ä¸å†æ˜¾ç¤º</p>
<pre><code>ceph crash archive &lt;crash-id&gt;

</code></pre>
<p>å½’æ¡£æ‰€æœ‰ä¿¡æ¯</p>
<pre><code>ceph crash archive-all
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[golangç¬”è®°-stringã€intã€int64äº’ç›¸è½¬æ¢]]></title>
        <id>http://lvelvis.github.io/post/golang-bi-ji-stringintint64-hu-xiang-zhuan-huan/</id>
        <link href="http://lvelvis.github.io/post/golang-bi-ji-stringintint64-hu-xiang-zhuan-huan/">
        </link>
        <updated>2020-08-10T08:35:04.000Z</updated>
        <content type="html"><![CDATA[<pre><code>#stringåˆ°int  
int,err:=strconv.Atoi(string)  
#stringåˆ°int64  
int64, err := strconv.ParseInt(string, 10, 64)  
#intåˆ°string  
string:=strconv.Itoa(int)  
#int64åˆ°string  
string:=strconv.FormatInt(int64,10)  ```

åŒç±»å‹ä¹‹é—´è½¬æ¢ï¼Œæ¯”å¦‚int64åˆ°intï¼Œç›´æ¥int(int64)å³å¯ï¼›
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[golangç¬”è®°-go-restful]]></title>
        <id>http://lvelvis.github.io/post/golang-bi-ji-go-restful/</id>
        <link href="http://lvelvis.github.io/post/golang-bi-ji-go-restful/">
        </link>
        <updated>2020-06-22T06:45:14.000Z</updated>
        <content type="html"><![CDATA[<p>ç”¨golangå†™ä¸€ä¸ªrestful apiã€‚å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯restful,å¯ä»¥çœ‹<a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">é˜®ä¸€å³°è€å¸ˆçš„æ•™ç¨‹</a></p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è§£å†³çš„æ˜¯è·¯ç”±çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•å°†ä¸åŒçš„urlæ˜ å°„åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°ã€‚</p>
<pre><code>    router.GET(&quot;/api/todo/:todoid&quot;, getTodoById)
    router.POST(&quot;/api/todo/&quot;, addTodo)
    router.DELETE(&quot;/api/todo/:todoid&quot;, deleteTodo)
    router.PUT(&quot;/api/todo/:todoid&quot;, modifyTodo)
</code></pre>
<p>ä½œä¸ºä¸€ä¸ªåˆå­¦è€…ï¼Œæˆ‘é©¬ä¸Šæ‰“å¼€github,æ‰¾åˆ°äº†<a href="https://github.com/avelino/awesome-go">awesome-go</a>,ç»è¿‡ä¸€ç•ªè°ƒç ”ï¼Œæˆ‘æ„Ÿè§‰æœ‰å‡ ä¸ªhttp routerçš„åº“æ¯”è¾ƒé€‚åˆï¼šbone, httprouter, mux</p>
<h2 id="åŸºæœ¬æ¡†æ¶">åŸºæœ¬æ¡†æ¶</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è®¾è®¡äº†å››ä¸ªè·¯ç”±ï¼Œåˆ†åˆ«ä¸ºæ ¹æ®Idè·å¾—todoï¼Œå¢åŠ todoï¼Œä¿®æ”¹todoï¼Œåˆ é™¤todoã€‚è¿™é‡Œå…³äºè§£æè·¯ç”±å‚æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†httprouter.Paramsçš„ByNameå‡½æ•°ã€‚</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;github.com/julienschmidt/httprouter&quot;
  &quot;net/http&quot;
  &quot;log&quot;
  &quot;io&quot;
  &quot;io/ioutil&quot;
)

func getTodoById(w http.ResponseWriter, r *http.Request, params httprouter.Params){
  todoid := params.ByName(&quot;todoid&quot;)
  fmt.Fprintf(w, &quot;getTodo %s\n&quot;, todoid)
}

func addTodo(w http.ResponseWriter, r *http.Request, _ httprouter.Params){
  body, _ := ioutil.ReadAll(io.LimitReader(r.Body, 1048576))
  fmt.Fprintf(w, &quot;addTodo! %s\n&quot;,body)
}

func deleteTodo(w http.ResponseWriter, r *http.Request, params httprouter.Params){
  todoid := params.ByName(&quot;todoid&quot;)
  fmt.Fprintf(w, &quot;deleteTodo %s\n&quot;, todoid)
}

func modifyTodo(w http.ResponseWriter, r *http.Request, params httprouter.Params){
  todoid := params.ByName(&quot;todoid&quot;)
  body, _ := ioutil.ReadAll(io.LimitReader(r.Body, 1048576))
  fmt.Fprintf(w, &quot;modifyTodo %s to %s\n&quot;, todoid, body)
}

func main() {
    router := httprouter.New()
    router.GET(&quot;/api/todo/:todoid&quot;, getTodoById)
    router.POST(&quot;/api/todo/&quot;, addTodo)
    router.DELETE(&quot;/api/todo/:todoid&quot;, deleteTodo)
    router.PUT(&quot;/api/todo/:todoid&quot;, modifyTodo)
    log.Fatal(http.ListenAndServe(&quot;:8080&quot;, router))
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥ç”¨curlæ¥æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„api,ä»¥putä¸ºä¾‹</p>
<pre><code>curl --data &quot;content=shopping&amp;time=tomorrow&quot; http://127.0.0.1:8080/api/todo/123 -X PUT

// modifyTodo 123 to content=shopping&amp;time=tomorrow
</code></pre>
<h2 id="jsonçš„è§£æ">jsonçš„è§£æ</h2>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨restful apiçš„æ—¶å€™ï¼Œå¸¸å¸¸éœ€è¦ç»™åå°ä¼ é€’æ•°æ®ã€‚ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡http.Requestçš„Bodyå±æ€§å¯ä»¥è·å¾—æ•°æ®</p>
<pre><code>body, _ := ioutil.ReadAll(io.LimitReader(r.Body, 1048576))
</code></pre>
<p>ä»ä¸Šé¢ï¼Œæˆ‘ä»¬è¯»å‡ºçš„æ•°æ®æ˜¯[]byteï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›å°†å…¶è§£æä¸ºå¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®šä¹‰æˆ‘ä»¬çš„structã€‚å‡è®¾æˆ‘ä»¬çš„todoåªæœ‰ä¸€ä¸ªå­—æ®µï¼Œå°±æ˜¯Name</p>
<pre><code>type Todo struct {
    Name      string
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿™æ ·è§£æ</p>
<pre><code>var todo Todo;
json.Unmarshal(body, &amp;todo);
</code></pre>
<h2 id="modelå±‚è®¾è®¡">modelå±‚è®¾è®¡</h2>
<pre><code>package main

import (
  &quot;gopkg.in/mgo.v2&quot;
  &quot;fmt&quot;
  &quot;log&quot;
  &quot;gopkg.in/mgo.v2/bson&quot;
)

var session *mgo.Session

func init(){
  session,_ = mgo.Dial(&quot;mongodb://127.0.0.1&quot;)
}

type Todo struct {
    Name      string
}

func createTodo(t Todo){
  c := session.DB(&quot;test&quot;).C(&quot;todo&quot;)
  c.Insert(&amp;t)
}

func queryTodoById(id string){
  c := session.DB(&quot;test&quot;).C(&quot;todo&quot;)
  result := Todo{}

  err := c.Find(bson.M{&quot;_id&quot;: bson.ObjectIdHex(id)}).One(&amp;result)
  if err != nil {
    log.Fatal(err)
  }

  fmt.Println(&quot;Todo:&quot;, result.Name)
}

func removeTodo(id string){
  c := session.DB(&quot;test&quot;).C(&quot;todo&quot;)
  err := c.Remove(bson.M{&quot;_id&quot;: bson.ObjectIdHex(id)})
  if err != nil{
    log.Fatal(err)
  }
}

func updateTodo(id string, update interface{}){
  //change := bson.M{&quot;$set&quot;: bson.M{&quot;name&quot;: &quot;hahaha&quot;}}
  c := session.DB(&quot;test&quot;).C(&quot;todo&quot;)
  err := c.Update(bson.M{&quot;_id&quot;: bson.ObjectIdHex(id)}, update)
  if err != nil{
    log.Fatal(err)
  }
}
</code></pre>
<p>æˆ‘ä»¬å®šä¹‰äº†Todoçš„struct,å¹¶æ·»åŠ äº†å‡ ç§å‡½æ•°ã€‚</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;github.com/julienschmidt/httprouter&quot;
  &quot;net/http&quot;
  &quot;log&quot;
  &quot;io&quot;
  &quot;io/ioutil&quot;
  &quot;encoding/json&quot;
  &quot;gopkg.in/mgo.v2/bson&quot;
)

func getTodoById(w http.ResponseWriter, r *http.Request, params httprouter.Params){
  todoid := params.ByName(&quot;todoid&quot;)
  queryTodoById(todoid)
  fmt.Fprintf(w, &quot;getUser %s\n&quot;, todoid)
}

func addTodo(w http.ResponseWriter, r *http.Request, _ httprouter.Params){
  body, _ := ioutil.ReadAll(io.LimitReader(r.Body, 1048576))
  var todo Todo;
  json.Unmarshal(body, &amp;todo);
  createTodo(todo)
  fmt.Fprintf(w, &quot;addUser! %s\n&quot;,body)
}

func deleteTodo(w http.ResponseWriter, r *http.Request, params httprouter.Params){
  todoid := params.ByName(&quot;todoid&quot;)
  removeTodo(todoid)
  fmt.Fprintf(w, &quot;deleteUser %s\n&quot;, todoid)
}

func modifyTodo(w http.ResponseWriter, r *http.Request, params httprouter.Params){
  todoid := params.ByName(&quot;todoid&quot;)
  body, _ := ioutil.ReadAll(io.LimitReader(r.Body, 1048576))
  var todo Todo
  json.Unmarshal(body, &amp;todo);
  change := bson.M{&quot;$set&quot;: bson.M{&quot;name&quot;: todo.Name}}
  updateTodo(todoid,change)
  fmt.Fprintf(w, &quot;modifyUser %s to %s\n&quot;, todoid, body)
}

func main() {
    router := httprouter.New()
    router.GET(&quot;/api/todo/:todoid&quot;, getTodoById)
    router.POST(&quot;/api/todo/&quot;, addTodo)
    router.DELETE(&quot;/api/todo/:todoid&quot;, deleteTodo)
    router.PUT(&quot;/api/todo/:todoid&quot;, modifyTodo)
    log.Fatal(http.ListenAndServe(&quot;:8080&quot;, router))
}</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[jenkins x on kuberneteså®è·µ(æ”¯æŒå¤šä¸»)]]></title>
        <id>http://lvelvis.github.io/post/jenkins-x-on-kubernetes-shi-jian-zhi-chi-duo-zhu/</id>
        <link href="http://lvelvis.github.io/post/jenkins-x-on-kubernetes-shi-jian-zhi-chi-duo-zhu/">
        </link>
        <updated>2020-06-18T02:26:17.000Z</updated>
        <content type="html"><![CDATA[<h2 id="jenkinsæ˜¯ä»€ä¹ˆ">jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>Jenkinsæ˜¯ä¸€ä¸ªå¼€æºçš„æŒç»­é›†æˆå·¥å…·ï¼Œå¯ç”¨äºè‡ªåŠ¨åŒ–çš„æ‰§è¡Œä¸æ„å»ºï¼Œæµ‹è¯•å’Œäº¤ä»˜æˆ–éƒ¨ç½²è½¯ä»¶æœ‰å…³çš„å„ç§ä»»åŠ¡,æœ‰éå¸¸ä¸°å¯Œçš„æ’ä»¶æ”¯æŒã€‚</p>
<h2 id="kubernetesæ˜¯ä»€ä¹ˆ">kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>Kubernetesæ˜¯å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªå¼€æºçš„å¹³å°ï¼Œå¯ä»¥å®ç°å®¹å™¨é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç»´æŠ¤ç­‰åŠŸèƒ½ã€‚è¿™ä¸ªè§†é¢‘ç”ŸåŠ¨åœ°ä»‹ç»äº†k8s</p>
<h2 id="jenkins-on-k8s-æœ‰ä»€ä¹ˆå¥½å¤„">jenkins on k8s æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</h2>
<p>jenkinsé€šè¿‡å•Masterå¤šä¸ªSlaveçš„æ–¹å¼æä¾›æœåŠ¡ï¼ŒMasterä¿å­˜äº†ä»»åŠ¡çš„é…ç½®ä¿¡æ¯ï¼Œå®‰è£…çš„æ’ä»¶ç­‰ç­‰ï¼Œè€Œslaveä¸»è¦è´Ÿè´£æ‰§è¡Œä»»åŠ¡ï¼Œåœ¨ä½¿ç”¨ä¸­å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å½“å­˜åœ¨å¤šä¸ªslaveæ—¶ï¼Œè¿è¡Œslaveçš„æœºå™¨éš¾ä»¥ç»Ÿä¸€ç®¡ç†ï¼Œæ¯æ¬¡æ·»åŠ æ–°èŠ‚ç‚¹æ—¶æ€»è¦åšå¤§é‡çš„é‡å¤å·¥ä½œã€‚</li>
<li>ç”±äºä¸åŒä¸šåŠ¡çš„æ„å»ºé¢‘ç‡å¹¶ä¸ç›¸åŒï¼Œåœ¨ä½¿ç”¨ä¼šå‘ç°æœ‰å¾ˆå¤šslaveå¤§å¤šæ•°æ—¶é—´éƒ½å¤„äºç©ºé—²çŠ¶æ€ï¼Œé€ æˆèµ„æºæµªè´¹</li>
<li>jenkinsé»˜è®¤é‡‡å–ä¿å®ˆçš„è°ƒåº¦æ–¹å¼ï¼Œé€ æˆæŸäº›slaveçš„è´Ÿè½½è¿‡é«˜ï¼Œä»»åŠ¡ä¸èƒ½å¹³å‡åˆ†é…</li>
</ol>
<h2 id="jenkinsæ¶æ„">jenkinsæ¶æ„</h2>
<p><img src="http://lvelvis.github.io/post-images/1592447693022.png" alt="" loading="lazy"><br>
ä½¿ç”¨k8sç®¡ç†jenkinså…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li>ä½¿ç”¨dockerè¿è¡Œjenkinsä¿è¯ç¯å¢ƒçš„ä¸€è‡´æ€§ï¼Œå¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡é€‰æ‹©åˆé€‚çš„é•œåƒ</li>
<li>k8så¯¹æŠ½è±¡åçš„èµ„æºï¼ˆpodsï¼‰è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†è°ƒåº¦ï¼Œæä¾›èµ„æºéš”ç¦»å’Œå…±äº«ï¼Œä½¿æœºå™¨è®¡ç®—èµ„æºå˜å¾—å¼¹æ€§å¯æ‰©å±•,é¿å…èµ„æºæµªè´¹ã€‚</li>
<li>k8sæä¾›å®¹å™¨çš„è‡ªæ„ˆåŠŸèƒ½ï¼Œèƒ½å¤Ÿä¿è¯å§‹ç»ˆæœ‰ä¸€å®šæ•°é‡çš„å®¹å™¨æ˜¯å¯ç”¨çš„</li>
<li>k8sé»˜è®¤çš„è°ƒåº¦å™¨æä¾›äº†é’ˆå¯¹èŠ‚ç‚¹å½“å‰èµ„æºåˆ†é…å®¹å™¨çš„è°ƒåº¦ç­–ç•¥ï¼Œè°ƒåº¦å™¨æ”¯æŒæ’ä»¶åŒ–éƒ¨ç½²ä¾¿äºè‡ªå®šä¹‰ã€‚</li>
</ol>
<h2 id="ä¸€æ­å»ºç¯å¢ƒ">ä¸€ï¼Œæ­å»ºç¯å¢ƒ</h2>
<h3 id="å·¥å…·å‡†å¤‡">å·¥å…·å‡†å¤‡</h3>
<pre><code>kubernetes v1.8.4
docker v1.12.6
jenkins masteré•œåƒ jenkins/jenkins:ltsï¼ˆv2.73.3ï¼‰
slaveé•œåƒ jenkinsci/jnlp-slave
Kubernetes plugin (v1.1)
</code></pre>
<h3 id="å®‰è£…kubernetesé›†ç¾¤">å®‰è£…kubernetesé›†ç¾¤</h3>
<p>ä¸­æ–‡æ•™ç¨‹ï¼šhttps://www.kubernetes.org.cn/2906.html<br>
çœç•¥.....</p>
<h2 id="äºŒåˆ›å»ºstatefulset">äºŒï¼Œåˆ›å»ºStatefulSet</h2>
<p>StatefulSet(æœ‰çŠ¶æ€å‰¯æœ¬é›†)ï¼šDeploymentsé€‚ç”¨äºè¿è¡Œæ— çŠ¶æ€åº”ç”¨ï¼ŒStatefulSetåˆ™ä¸ºæœ‰çŠ¶æ€çš„åº”ç”¨æä¾›äº†æ”¯æŒï¼Œå¯ä»¥ä¸ºåº”ç”¨æä¾›æœ‰åºçš„éƒ¨ç½²å’Œæ‰©å±•ï¼Œç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œæˆ‘ä»¬ä½¿ç”¨SSæ¥è¿è¡Œjenkins masterã€‚</p>
<p>åˆ›å»ºå®Œæ•´çš„Stateful Setéœ€è¦ä¾æ¬¡åˆ›å»ºä¸€ä¸‹å¯¹è±¡ï¼š<br>
1ã€Persistent Volume<br>
2ã€Persistent Volume Claim<br>
3ã€StatefulSet<br>
4ã€Service</p>
<p>åˆ›å»ºPersistentVolumeï¼š<br>
ä¸ºäº†ä¿å­˜åº”ç”¨è¿è¡Œæ—¶çš„æ•°æ®éœ€è¦å…ˆåˆ›å»ºk8sçš„å·æ–‡ä»¶ï¼ŒK8sä¸­å­˜åœ¨Volumeå’ŒPersistentVolumeä¸¤ç§ç±»å‹ï¼š</p>
<ol>
<li>Volumeï¼šä¸dockerä¸­çš„volumeä¸åŒåœ¨äºVolumeç”Ÿå‘½å‘¨æœŸæ˜¯å’Œpodç»‘å®šçš„ï¼Œä¸podä¸­çš„containeræ— å…³ã€‚k8sä¸ºVolumeæä¾›äº†å¤šç§ç±»å‹æ–‡ä»¶ç³»ç»Ÿï¼ˆcephfs,nfsâ€¦,ç®€å•èµ·è§æˆ‘ç›´æ¥é€‰æ‹©äº†hostPathï¼Œä½¿ç”¨çš„nodeèŠ‚ç‚¹æœ¬åœ°çš„å­˜å‚¨ç³»ç»Ÿï¼‰</li>
<li>PersistentVolume:ä»åå­—å¯ä»¥çœ‹å‡ºæ¥ï¼ŒPVçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºä½¿ç”¨å®ƒçš„podï¼Œä¸ä¼šåƒvolumeéšpodæ¶ˆå¤±è€Œæ¶ˆå¤±ï¼Œè€Œæ˜¯åšä¸ºä¸€ä¸ªé›†ç¾¤ä¸­çš„èµ„æºå­˜åœ¨ï¼ˆåƒnodeèŠ‚ç‚¹ä¸€æ ·ï¼‰ï¼ŒåŒæ—¶PVå±è”½äº†ä½¿ç”¨å…·ä½“å­˜å‚¨ç³»ç»Ÿçš„ç»†èŠ‚ã€‚<br>
k8sä¸­çš„å¯¹è±¡éƒ½æ˜¯é€šè¿‡yamlæ–‡ä»¶æ¥å®šä¹‰çš„ï¼Œé¦–å…ˆåˆ›å»ºåä¸ºjenkins-volume.ymlçš„æ–‡ä»¶:</li>
</ol>
<p>â£ï¸â£ï¸æ³¨æ„ï¼šPVçš„åˆ›å»ºæœ‰é™æ€ï¼ŒåŠ¨æ€ä¸¤ç§æ–¹å¼ï¼ŒåŠ¨æ€åˆ›å»ºå¯ä»¥å‡å°‘ç®¡ç†å‘˜çš„æ“ä½œæ­¥éª¤ï¼Œéœ€è¦æä¾›æŒ‡å®šçš„StorageClassã€‚ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥é€‰æ‹©é™æ€åˆ›å»ºï¼Œmanualæ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„storage class</p>
<pre><code>kind: PersistentVolume
apiVersion: v1
metadata:
  name: jenkins-volume
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/tmp/data&quot;
</code></pre>
<p>masterèŠ‚ç‚¹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒPVå°±æ‰‹åŠ¨åˆ›å»ºå®Œäº†</p>
<pre><code>kubectl create -f jenkins-volume1.yaml
</code></pre>
<p>åˆ›å»ºPersistentVolumeClaimï¼š</p>
<pre><code>PersistentVolumeClaim(PVC):
æŒä¹…åŒ–å­˜å‚¨å·ç´¢å–ï¼Œå¦‚æœè¯´PVæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼ŒPVCå°±æ˜¯èµ„æºçš„æ¶ˆè´¹è€…ï¼ŒPVCå¯ä»¥æŒ‡å®šéœ€è¦çš„èµ„æºå¤§å°å’Œè®¿é—®æ–¹å¼,podä¸ä¼šå’ŒPVç›´æ¥æ¥è§¦ï¼Œè€Œæ˜¯é€šè¿‡PVCæ¥è¯·æ±‚èµ„æºï¼ŒPVçš„ç”Ÿæˆé˜¶æ®µå«åšprovision,ç”ŸæˆPVåä¼šç»‘å®šåˆ°PVCå¯¹è±¡ï¼Œç„¶åæ‰èƒ½è¢«å…¶ä»–å¯¹è±¡ä½¿ç”¨ã€‚
</code></pre>
<p>PVå’ŒPVCçš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹å›¾ï¼š<br>
<img src="http://lvelvis.github.io/post-images/1592447954632.png" alt="" loading="lazy">pv life<br>
åˆ›å»ºæ–‡ä»¶jenkins-claim.yaml<br>
æ³¨æ„ï¼š nameå¿…é¡»ä¸ºjenkins-home-jenkins-0å¦åˆ™ä¼šç»‘å®šå¤±è´¥</p>
<pre><code>kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: jenkins-home-jenkins-0
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 3Gi
</code></pre>
<p>æ‰§è¡Œå‘½ä»¤kubectl create -f jenkins-claim.yaml<br>
ç„¶åæŸ¥çœ‹PVCæ˜¯å¦åˆ›å»ºæˆåŠŸï¼Œstatusä¸ºboundè¯´æ˜PVCå·²ç»ç»‘å®š</p>
<pre><code>[root@master ~]# kubectl describe pvc jenkins-home-jenkins-0
Name:          jenkins-home-jenkins-0
Namespace:     kubernetes-plugin
StorageClass:  manual
Status:        Bound
Volume:        jenkins-volume
Labels:        &lt;none&gt;
Annotations:   pv.kubernetes.io/bind-completed=yes
               pv.kubernetes.io/bound-by-controller=yes
Capacity:      10Gi
Access Modes:  RWO
Events:        &lt;none&gt;
</code></pre>
<p>åˆ›å»ºStatefulSetå’ŒServiceï¼š<br>
ä»kubernetes-plugin githubä»“åº“ä¸‹è½½jenkins.ymlæ–‡ä»¶</p>
<pre><code>wget https://raw.githubusercontent.com/jenkinsci/kubernetes-plugin/master/src/main/kubernetes/jenkins.yml
ä¿®æ”¹jenkins.ymlï¼š
å»æ‰87è¡ŒexternalTrafficPolicy: Localï¼ˆè¿™æ˜¯GKEä½¿ç”¨çš„ï¼‰
ä¿®æ”¹83è¡Œtype: LoadBalanceræ”¹ä¸ºtype: NodePort
</code></pre>
<p>æ³¨æ„ï¼š<br>
service type=ClusterIPæ—¶åªå…è®¸ä»é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œ typeè®¾ç½®ä¸ºNodePortæ˜¯ä¸ºäº†ä»é›†ç¾¤å¤–çš„æœºå™¨è®¿é—®jenkins,è¯·è°¨æ…ä½¿ç”¨ï¼Œå¼€å¯NodePortä¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹ï¼ˆå«masterï¼‰çš„ç»Ÿä¸€å›ºå®šç«¯å£å¼€æ”¾æœåŠ¡ã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤</p>
<pre><code>[root@master ~]# kubectl create -f jenkins.yml 
statefulset &quot;jenkins&quot; created
service &quot;jenkins&quot; created
è®¿é—®jenkins master,åœ°å€ä¸ºmasterip:32058
</code></pre>
<p>#æŸ¥çœ‹æ˜ å°„çš„ç«¯å£</p>
<pre><code>[root@master ~]# kubectl get service jenkins
NAME      TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)                        AGE
jenkins   NodePort   10.96.82.68   &lt;none&gt;        80:32058/TCP,50000:30345/TCP   1m

</code></pre>
<p>æŸ¥çœ‹pod : jenkins-0çš„å®¹å™¨æ—¥å¿—ï¼Œç²˜è´´ä¸‹é¢çš„å¯†ç è¿›å…¥jenkins,jenkinså®‰è£…å®Œæˆã€‚</p>
<pre><code>Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:
70aa7b41ba894855abccd09306625b8a
</code></pre>
<h3 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ</h3>
<p>1.åˆ›å»ºstateful setæ—¶å¤±è´¥ï¼Œæç¤ºâ€PersistentVolumeClaim is not bound: â€œjenkins-home-jenkins-0â€ï¼šâ€<br>
å› ä¸ºé‡‡ç”¨é™æ€åˆ›å»ºPVæ—¶ï¼ŒStatefulSetä¼šæŒ‰ç…§å›ºå®šåç§°æŸ¥æ‰¾PVCï¼ŒPVCçš„åå­—è¦æ»¡è¶³</p>
<p>PVC_name == volumeClaimTemplates_name + â€œ-â€œ + pod_name</p>
<p>è¿™é‡Œçš„åå­—å°±æ˜¯jenkins-home-jenkins-0</p>
<p>2.podå¯åŠ¨å¤±è´¥ï¼Œjenkinsç”¨æˆ·æ²¡æœ‰ç›®å½•æƒé™<br>
é”™è¯¯æç¤ºâ€touch: cannot touch â€˜/var/jenkins_home/copy_reference_file.logâ€™: Permission denied<br>
Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?â€<br>
è¦ç¡®ä¿èŠ‚ç‚¹ç›®å½•å¼€æ”¾æƒé™,åœ¨nodeä¸Šæ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre><code>sudo chown -R 1000:1000 /var/jenkins_home/
sudo chown -R 1000:1000 /tmp/data
##å¦‚æœä»ç„¶å¤±è´¥ï¼Œå°è¯•åœ¨nodeä¸Šé‡å¯docker
systemctl restart docker
</code></pre>
<p>æ³¨æ„pvæŒ‡å®šçš„hostPathæƒé™ä¹Ÿè¦ä¿®æ”¹ï¼Œå¦åˆ™æ˜¯æ— æ•ˆçš„</p>
<h2 id="ä¸‰-é…ç½®jenkins">ä¸‰ ï¼Œé…ç½®jenkins</h2>
<p>åˆ›å»ºjenkinsæœåŠ¡è´¦å·</p>
<pre><code>wget https://raw.githubusercontent.com/jenkinsci/kubernetes-plugin/master/src/main/kubernetes/service-account.yml
kubectl create -f service-account.yml
</code></pre>
<p>é…ç½®æ’ä»¶<br>
è®¿é—®http://masterip:32058/pluginManager/,æœç´¢æ’ä»¶Kubernetes pluginå®‰è£…ï¼›<br>
è®¿é—® http://masterip:32058/configure<br>
é€‰æ‹©æ–°å»ºäº‘â€“kubernetes,åœ¨URlå¡«å†™api serveråœ°å€ï¼Œ<br>
æ‰§è¡Œkubectl describeå‘½ä»¤ï¼Œå¤åˆ¶outputä¸­çš„tokenï¼Œå¡«å…¥åˆ° â€˜Kubernetes server certificate keyâ€™</p>
<p>[root@master ~]# kubectl get secret<br>
NAME                  TYPE                                  DATA      AGE<br>
default-token-4kb54   kubernetes.io/service-account-token   3         1d<br>
jenkins-token-wzbsx   kubernetes.io/service-account-token   3         1d<br>
[root@master ~]# kubectl describe secret/jenkins-token-wzbsx<br>
...<br>
jenkins url,tunnelå¡«å†™serviceçš„CLUSTER-IPå³å¯ï¼Œç»“æœå¦‚å›¾ï¼š<br>
<img src="http://lvelvis.github.io/post-images/1592448124617.png" alt="" loading="lazy">peizhi1<br>
é€‰æ‹©add pod templateï¼Œå¡«å†™ä¸‹é¢çš„å†…å®¹ï¼Œretain slaveå¯ä»¥è®¾ç½®è¿è¡Œjenkins slave çš„containerç©ºé—²åèƒ½å­˜æ´»å¤šä¹…ã€‚<br>
<img src="http://lvelvis.github.io/post-images/1592448148171.png" alt="" loading="lazy">content<br>
æ’ä»¶é…ç½®å®Œæˆã€‚</p>
<h2 id="å››-æµ‹è¯•">å›› ï¼Œæµ‹è¯•</h2>
<ol>
<li>æ‰©å®¹æµ‹è¯•<br>
StatefulSetæ‰©å®¹ï¼š<br>
é¦–å…ˆéœ€è¦æ‰‹åŠ¨åˆ›å»ºPVï¼ŒPVC(è§ç¬¬äºŒæ­¥),ç„¶åæ‰§è¡Œæ‰©å®¹å‘½ä»¤</li>
</ol>
<pre><code>kubectl scale statefulset/jenkins --replicas=ï¼’
</code></pre>
<p>æŸ¥çœ‹StatefulSet,æ­¤æ—¶å·²ç»æ‹¥æœ‰ä¸¤ä¸ªmasterèŠ‚ç‚¹ï¼Œè®¿é—®serviceæ—¶ä¼šéšæœºå°†è¯·æ±‚å‘é€ç»™åç«¯çš„masterã€‚</p>
<pre><code>[root@master ~]# kubectl get statefulset/jenkins 
NAME      DESIRED   CURRENT   AGE
jenkins   2         2         5d
</code></pre>
<p>è™½ç„¶é€šè¿‡k8så¯ä»¥è½»æ¾å®ç°jenkins masterèŠ‚ç‚¹çš„æ‹“å±•ï¼Œä½†æ˜¯ç”±äºjenkinså­˜å‚¨æ•°æ®çš„æ–¹å¼é€šè¿‡æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼Œmasterä¹‹é—´çš„æ•°æ®åŒæ­¥è¿˜æ˜¯ä¸€ä¸ªéº»çƒ¦çš„é—®é¢˜ï¼Œå‚è€ƒjenkinså­˜å‚¨æ¨¡å‹ã€‚</p>
<p>jenkins masterä¸Šä¿å­˜çš„æ–‡ä»¶ï¼š</p>
<pre><code>ls /temp/data
jenkins.CLI.xml
jenkins.install.InstallUtil.lastExecVersion
jenkins.install.UpgradeWizard.state
jenkins.model.ArtifactManagerConfiguration.xml
jenkins.model.JenkinsLocationConfiguration.xml
jobs
logs
nodeMonitors.xml
nodes
</code></pre>
<ol start="2">
<li>é«˜å¯ç”¨æµ‹è¯•<br>
ç°åœ¨stateful setä¸­å·²ç»æœ‰ä¸¤ä¸ªpod,åœ¨jenkins-1æ‰€åœ¨çš„èŠ‚ç‚¹æ‰§è¡Œdocker stopåœæ­¢è¿è¡Œjenkins-masterçš„å®¹å™¨ï¼ŒåŒæ—¶åœ¨å‘½ä»¤è¡ŒæŸ¥çœ‹podçš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°jenkins-1å¼‚å¸¸ï¼ˆErrorçŠ¶æ€ï¼‰ä¹‹åæ…¢æ…¢æ¢å¤äº†è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰ï¼š</li>
</ol>
<pre><code>[root@master ~]# kubectl get pods -w
NAME        READY     STATUS    RESTARTS   AGE
jenkins-0   1/1       Running   0          1d
jenkins-1   0/1       Running   1         20h
jenkins-1   1/1       Running   1         20h
jenkins-1   0/1       Error     1         20h
jenkins-1   0/1       CrashLoopBackOff   1         20h
jenkins-1   0/1       Running   2         20h
jenkins-1   1/1       Running   2         20h
</code></pre>
<p>kubectl describe pod jenkins-1æŸ¥çœ‹podçš„äº‹ä»¶æ—¥å¿—ï¼Œk8sé€šè¿‡æ¢é’ˆ(probe)æ¥å£æ£€æµ‹åˆ°æœåŠ¡åœæ­¢ä¹‹åè‡ªåŠ¨æ‰§è¡Œäº†æ‹‰å–é•œåƒï¼Œé‡å¯containerçš„æ“ä½œã€‚</p>
<pre><code>Events:
  Type     Reason      Age                From                              Message
  ----     ------      ----               ----                              -------
  Warning  Unhealthy   27m (x2 over 27m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Readiness probe failed: HTTP probe failed with statuscode: 503
  Warning  Unhealthy   27m (x2 over 27m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Liveness probe failed: HTTP probe failed with statuscode: 503
  Warning  Unhealthy   24m                kubelet, iz8pscwd1fv6kprs1zw21kz  Readiness probe failed: Get http://192.168.24.4:8080/login: dial tcp 192.168.24.4:8080: getsockopt: connection refused
  Warning  BackOff     20m (x2 over 20m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Back-off restarting failed container
  Warning  FailedSync  20m (x2 over 20m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Error syncing pod
  Normal   Pulling     19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  pulling image &quot;jenkins/jenkins:lts-alpine&quot;
  Normal   Started     19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  Started container
  Normal   Pulled      19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  Successfully pulled image &quot;jenkins/jenkins:lts-alpine&quot;
  Normal   Created     19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  Created container
</code></pre>
<ol start="3">
<li>jenkinsæ„å»ºæµ‹è¯•<br>
å½“å‰é›†ç¾¤ä¸­ä½¿ç”¨çš„jenkins slaveé•œåƒåªåŒ…å«ä¸€ä¸ªjavaè¿è¡Œç¯å¢ƒæ¥è¿è¡Œjenkins-slave.jar,åœ¨å®é™…ä½¿ç”¨ä¸­éœ€è¦è‡ªå®šä¹‰åˆé€‚çš„é•œåƒã€‚é€‰æ‹©è‡ªå®šä¹‰é•œåƒä¹‹åéœ€è¦ä¿®æ”¹æ’ä»¶çš„é…ç½®ï¼ŒåŒæ ·nameå‘½åä¸ºjnlpæ›¿æ¢é»˜è®¤é•œåƒï¼Œargumentså®‰è£…å·¥å…·æç¤ºå¡«å†™å³å¯ã€‚<br>
<img src="http://lvelvis.github.io/post-images/1592448208433.png" alt="" loading="lazy"><br>
åˆ›å»ºjobï¼ŒåŒæ—¶å¼€å§‹æ„å»º,k8sä¼šåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šåˆ›å»ºpodæ¥è¿è¡Œä»»åŠ¡</li>
</ol>
<p>jenkinsé»˜è®¤è°ƒåº¦ç­–ç•¥</p>
<ol>
<li>å°è¯•åœ¨ä¸Šæ¬¡æ„å»ºçš„èŠ‚ç‚¹ä¸Šæ„å»ºï¼ŒæŒ‡å®šæŸå°slaveä¹‹åä¼šä¸€ç›´ä½¿ç”¨ã€‚</li>
<li>å½“é˜Ÿåˆ—æœ‰2ä¸ªæ„å»ºæ—¶ï¼Œä¸ä¼šç«‹åˆ»åˆ›å»ºä¸¤ä¸ªexecutor,è€Œæ˜¯å…ˆåˆ›å»ºä¸€ä¸ªexecutorç„¶åå°è¯•ç­‰å¾…executorç©ºé—²ï¼Œç›®çš„æ˜¯ä¿è¯æ¯ä¸ªexecutorè¢«å……åˆ†åˆ©ç”¨ã€‚<br>
k8sè°ƒåº¦ç­–ç•¥<br>
ä½¿ç”¨Pod.spec.nodeSelectoræ ¹æ®labelä¸ºpodé€‰æ‹©node<br>
3 .è°ƒåº¦å™¨scheduleræœ‰Predicatesï¼ŒPrioritiesä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«è´Ÿè´£èŠ‚ç‚¹è¿‡æ»¤å’Œè¯„åˆ†æ’åºï¼Œå„ä¸ªé˜¶æ®µéƒ½æœ‰k8sæä¾›çš„æ£€æŸ¥é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±ç»„åˆã€‚<br>
ï¼ˆæ¯”å¦‚PodFitsResourcesæ£€æŸ¥cpuå†…å­˜ç­‰èµ„æºï¼ŒPodFitsHostPortsæ£€æŸ¥ç«¯å£å ç”¨ï¼ŒSelectorSpreadPriorityè¦æ±‚ä¸€ä¸ªæœåŠ¡å°½é‡åˆ†æ•£åˆ†å¸ƒï¼‰è‡ªå®šä¹‰schdulerå‚è€ƒ<br>
èµ„æºä¸è¶³æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ<br>
å½“å‰é›†ç¾¤ä¸­æœ‰3ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘åœ¨node2è¿è¡Œä¸€ä¸ªCPUå ç”¨é™åˆ¶åœ¨80%çš„ç¨‹åº,ç„¶åè®¾ç½®jenkinsæ’ä»¶ContainerTemplateçš„requestå’Œlimitå‡ä¸ºcpu 500m,å†…å­˜500Mi,ï¼ˆ500mä»£è¡¨å•æ ¸CPUçš„50%ï¼‰çœ‹ä¸€ä¸‹podä¼šæ€ä¹ˆè°ƒåº¦<br>
k8sä»ç„¶å°è¯•åœ¨node2åˆ†é…èŠ‚ç‚¹ï¼ˆä¸ºä»€ä¹ˆå…¶ä»–èŠ‚ç‚¹ä¸è¡Œï¼‰ï¼Œç»“æœPODå¤„äºpendingçŠ¶æ€ï¼š</li>
</ol>
<pre><code>{
&quot;phase&quot;: &quot;Pending&quot;,
&quot;conditions&quot;: [
  {
    &quot;type&quot;: &quot;PodScheduled&quot;,
    &quot;status&quot;: &quot;False&quot;,
    &quot;lastProbeTime&quot;: null,
    &quot;lastTransitionTime&quot;: &quot;2017-12-09T08:29:10Z&quot;,
    &quot;reason&quot;: &quot;Unschedulable&quot;,
    &quot;message&quot;: &quot;No nodes are available that match all of the predicates: Insufficient cpu (4), PodToleratesNodeTaints (1).&quot;
  }
],
&quot;qosClass&quot;: &quot;Guaranteed&quot;
</code></pre>
<p>æœ€åpodè¢«åˆ é™¤ï¼Œè€Œjenkinsä»»åŠ¡ä¼šé˜»å¡ä¸€ç›´åˆ°æœ‰å…¶ä»–ç©ºé—²çš„slaveå‡ºç°ã€‚</p>
<h2 id="äº”æ€»ç»“">äº”ï¼Œæ€»ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†åœ¨k8sé›†ç¾¤éƒ¨ç½²jenkinsæœåŠ¡çš„æ–¹å¼å’Œk8så¸¦æ¥çš„èµ„æºç®¡ç†ä¾¿æ·ï¼Œç”±äºæˆ‘ä¹Ÿæ˜¯åˆšå¼€å§‹æ¥è§¦k8s,æ‰€ç”¨çš„å®ä¾‹åªæ˜¯æ­å»ºäº†ç”¨äºæµ‹è¯•çš„å®éªŒç¯å¢ƒï¼Œç¦»åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨è¿˜æœ‰é—®é¢˜éœ€è¦éªŒè¯ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[consul-åˆ é™¤æ— æ•ˆæœåŠ¡ä¸èŠ‚ç‚¹]]></title>
        <id>http://lvelvis.github.io/post/consul-shan-chu-wu-xiao-fu-wu-yu-jie-dian/</id>
        <link href="http://lvelvis.github.io/post/consul-shan-chu-wu-xiao-fu-wu-yu-jie-dian/">
        </link>
        <updated>2020-06-17T09:43:15.000Z</updated>
        <content type="html"><![CDATA[<p>consulåˆ é™¤æ— æ•ˆå®ä¾‹<br>
http://127.0.0.1:8500/v1/agent/service/deregister/test-9c14fa595ddfb8f4c34c673c65b072bb</p>
<p>test-9c14fa595ddfb8f4c34c673c65b072bb : å®ä¾‹id<br>
method : put</p>
<p>åˆ é™¤æ— æ•ˆèŠ‚ç‚¹<br>
http://127.0.0.1:8500/v1/v1/agent/force-leave/4b36b27317a0</p>
<p>consul leave #å…³é—­consulå¹¶ç¦»å¼€é›†ç¾¤ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨Ctrl+Cæˆ–kill -INTæ¥gracefullyåœæ­¢agentï¼Œè¿™ç§ä½“é¢çš„ç¦»å¼€æ–¹å¼è®©consuleå¯ä»¥æœ‰æœºä¼šé€šçŸ¥é›†ç¾¤å…¶ä»–æˆå‘˜è‡ªå·±çš„ç¦»å¼€ã€‚å¦‚æœä½ å¼ºåˆ¶åœ°ç»“æŸäº†agentï¼Œå…¶ä»–memberä¼šæ£€æµ‹åˆ°è¿™ä¸ªèŠ‚ç‚¹çš„failedã€‚å½“æˆå‘˜ç¦»å¼€æ—¶ï¼Œå®ƒçš„serviceså’Œcheckséƒ½ä¼šä»catalogä¸­ç§»é™¤ã€‚å½“æˆå‘˜failedæ—¶ï¼Œå®ƒçš„healthåªæ˜¯ç®€å•çš„è¢«æ ‡è®°ä¸ºcriticalï¼Œå¹¶ä¸ä¼šä»catalogä¸­ç§»é™¤ã€‚Consulä¼šè‡ªåŠ¨å°è¯•é‡æ–°è¿æ¥failedèŠ‚ç‚¹ï¼Œå…è®¸å®ƒä»æ¶åŠ£çš„ç½‘ç»œç¯å¢ƒä¸­æ¢å¤ï¼Œæ˜¾ç„¶ç¦»å¼€çš„nodesä¸ä¼šè¢«é‡æ–°è¿æ¥ã€‚å¦å¤–ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯serverï¼Œä½“é¢çš„ç¦»å¼€å¯¹é¿å…æ½œåœ¨çš„ä¸­æ–­çš„å¯èƒ½å¾ˆé‡è¦ã€‚<br>
ä¸ºäº†é˜²æ­¢dead nodesçš„ç§¯ç´¯ï¼Œconsulä¼šè‡ªåŠ¨æŠŠdead nodesç§»é™¤å‡ºcatalogã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºreapingï¼ˆæ”¶å‰²ï¼‰ã€‚é»˜è®¤æ˜¯72å°æ—¶çš„é—´éš”ï¼ˆä¸å»ºè®®æ›´æ”¹ï¼‰</p>
<pre><code>#!/bin/bash
clear 
echo &quot;node_exporteræ³¨é”€å·¥å…·&quot;
read -p &quot;è¯·è¾“å…¥è¦è¸¢æ‰çš„èŠ‚ç‚¹IP,å¦‚æœæœ‰å¤šä¸ªIP,è¯·ä½¿ç”¨è‹±æ–‡æ ¼å¼ ',' éš”å¼€: &quot; IP_LIST

for IP in `echo &quot;${IP_LIST}&quot;|awk -F, 'BEGIN{OFS=&quot; &quot;}{$1=$1;printf(&quot;%s&quot;,$0);}'`
do 
   curl -XPUT http://10.100.x.x:8500/v1/agent/service/deregister/node-${IP}
   echo &quot;${IP}èŠ‚ç‚¹å·²å‰”é™¤!&quot;
done
echo &quot;${IP_LIST}å®Œæˆå‰”é™¤&quot;
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[docker - å†…å­˜ä½¿ç”¨ç‡å·®å¼‚:cgroup memory.usage_in_bytesä¸dockerå®¹å™¨å†…çš„RSS]]></title>
        <id>http://lvelvis.github.io/post/docker-nei-cun-shi-yong-lu-chai-yi-cgroup-memoryusage_in_bytes-yu-docker-rong-qi-nei-de-rss/</id>
        <link href="http://lvelvis.github.io/post/docker-nei-cun-shi-yong-lu-chai-yi-cgroup-memoryusage_in_bytes-yu-docker-rong-qi-nei-de-rss/">
        </link>
        <updated>2020-06-17T03:46:43.000Z</updated>
        <content type="html"><![CDATA[<p>&quot;kubernetes&quot;ï¼ˆv1.10.2ï¼‰è¡¨ç¤ºæˆ‘çš„podï¼ˆåŒ…å«ä¸€ä¸ªå®¹å™¨ï¼‰ä½¿ç”¨äº†å¤§çº¦5GBçš„å†…å­˜ã€‚åœ¨å®¹å™¨å†…éƒ¨ï¼ŒRSSè¯´çš„æ›´åƒ681Mibã€‚ä»»ä½•äººéƒ½èƒ½ç”¨ä»¥ä¸‹æ•°æ®è§£é‡Šå¦‚ä½•ä»681Mibåˆ°5GBå—ï¼ˆæˆ–è€…ç”¨æˆ‘çœç•¥çš„å¦ä¸€ä¸ªå‘½ä»¤æ¥æè¿°å¦‚ä½•å¼¥è¡¥å·®å¼‚ï¼Œæ— è®ºæ˜¯ä»å®¹å™¨è¿˜æ˜¯ä»åœ¨Kubernetesä¸­è¿è¡Œæ­¤å®¹å™¨çš„Dockerä¸»æœºï¼‰ï¼Ÿ<br>
Kubectl Top Podsè¡¨ç¤º5GBï¼š</p>
<pre><code>% kubectl top pods -l app=myapp
NAME                             CPU(cores)   MEMORY(bytes)
myapp-56b947bf6d-2lcr7           39m          5039Mi
</code></pre>
<p>CadvisoræŠ¥å‘Šäº†ç±»ä¼¼çš„æ•°å­—ï¼ˆå¯èƒ½æ¥è‡ªç¨æœ‰ä¸åŒçš„æ—¶é—´ï¼Œå› æ­¤è¯·å¿½ç•¥ç»†å¾®çš„å·®å¼‚ï¼‰ï¼š</p>
<pre><code>container_memory_usage_bytes{pod_name=~&quot;.*myapp.*&quot;}      5309456384

5309456384 / 1024.0 / 1024 ~= 5063 ~= 5039
</code></pre>
<p>åœ¨å®¹å™¨ä¸­ï¼Œæ­¤æ–‡ä»¶ä¼¼ä¹æ˜¯cadvisorè·å–å…¶æ•°æ®çš„ä½ç½®ï¼š</p>
<pre><code># kubectl exec -it myapp-56b947bf6d-2lcr7 bash
meme@myapp-56b947bf6d-2lcr7:/app# cat /sys/fs/cgroup/memory/memory.usage_in_bytes
5309456384
å®¹å™¨ä¸­çš„å¸¸é©»é›†å¤§å°ï¼ˆRSSï¼‰ä¸åŒ¹é…ï¼ˆå°äº1GBï¼‰ï¼š
meme@myapp-56b947bf6d-2lcr7:/app# kb=$(ps aux | grep -v grep | grep -v 'ps aux' | grep -v bash | grep -v awk | grep -v RSS | awk '{print $6}' | awk '{s+=$1} END {printf &quot;%.0f&quot;, s}'); mb=$(expr $kb / 1024); printf &quot;Kb: $kb\nMb: $mb\n&quot;
Kb: 698076
Mb: 681
</code></pre>
<pre><code>å®Œæ•´çš„PS AUXï¼Œä»¥é˜²æœ‰å¸®åŠ©ï¼š
meme@myapp-56b947bf6d-2lcr7:/app# ps aux | grep -v grep | grep -v 'ps aux' | grep -v bash | grep -v awk
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
meme         1  0.0  0.0 151840 10984 ?        Ss   Jun04   0:29 /usr/sbin/apache2 -D FOREGROUND
www-data    10  0.0  0.0 147340  4652 ?        S    Jun04   0:00 /usr/sbin/apache2 -D FOREGROUND
www-data    11  0.0  0.0 148556  4392 ?        S    Jun04   0:16 /usr/sbin/apache2 -D FOREGROUND
www-data    12  0.2  0.0 2080632 11348 ?       Sl   Jun04  31:58 /usr/sbin/apache2 -D FOREGROUND
www-data    13  0.1  0.0 2080384 10980 ?       Sl   Jun04  18:12 /usr/sbin/apache2 -D FOREGROUND
www-data    68  0.3  0.0 349048 94272 ?        Sl   Jun04  47:09 hotapp
www-data   176  0.2  0.0 349624 92888 ?        Sl   Jun04  43:11 hotapp
www-data   179  0.2  0.0 349196 94456 ?        Sl   Jun04  42:20 hotapp
www-data   180  0.3  0.0 349828 95112 ?        Sl   Jun04  44:14 hotapp
www-data   185  0.3  0.0 346644 91948 ?        Sl   Jun04  43:49 hotapp
www-data   186  0.3  0.0 346208 91568 ?        Sl   Jun04  44:27 hotapp
www-data   189  0.2  0.0 350208 95476 ?        Sl   Jun04  41:47 hotapp
</code></pre>
<p>Dockerå®¹å™¨ç»Ÿè®¡APIä¸­çš„å†…å­˜éƒ¨åˆ†ï¼š</p>
<pre><code>curl --unix-socket /var/run/docker.sock 'http:/v1.24/containers/a45fc651e7b12f527b677e6a46e2902786bee6620484922016a135e317a42b4e/stats?stream=false' | jq . # yields:

&quot;memory_stats&quot;: {
  &quot;usage&quot;: 5327712256,
  &quot;max_usage&quot;: 5368344576,
  &quot;stats&quot;: {
    &quot;active_anon&quot;: 609095680,
    &quot;active_file&quot;: 74457088,
    &quot;cache&quot;: 109944832,
    &quot;dirty&quot;: 28672,
    &quot;hierarchical_memory_limit&quot;: 5368709120,
    &quot;inactive_anon&quot;: 1687552,
    &quot;inactive_file&quot;: 29974528,
    &quot;mapped_file&quot;: 1675264,
    &quot;pgfault&quot;: 295316278,
    &quot;pgmajfault&quot;: 77,
    &quot;pgpgin&quot;: 85138921,
    &quot;pgpgout&quot;: 84964308,
    &quot;rss&quot;: 605270016,
    &quot;rss_huge&quot;: 0,
    &quot;shmem&quot;: 5513216,
    &quot;total_active_anon&quot;: 609095680,
    &quot;total_active_file&quot;: 74457088,
    &quot;total_cache&quot;: 109944832,
    &quot;total_dirty&quot;: 28672,
    &quot;total_inactive_anon&quot;: 1687552,
    &quot;total_inactive_file&quot;: 29974528,
    &quot;total_mapped_file&quot;: 1675264,
    &quot;total_pgfault&quot;: 295316278,
    &quot;total_pgmajfault&quot;: 77,
    &quot;total_pgpgin&quot;: 85138921,
    &quot;total_pgpgout&quot;: 84964308,
    &quot;total_rss&quot;: 605270016,
    &quot;total_rss_huge&quot;: 0,
    &quot;total_shmem&quot;: 5513216,
    &quot;total_unevictable&quot;: 0,
    &quot;total_writeback&quot;: 0,
    &quot;unevictable&quot;: 0,
    &quot;writeback&quot;: 0
  },
  &quot;limit&quot;: 5368709120
},
</code></pre>
<p>å¯¹æ–­è¨€çš„æ³¨é‡Šï¼š<br>
æ€»è®¡ï¼ˆmemory.usage_in_bytesï¼‰=rss+ç¼“å­˜<br>
è¯´ï¼š<br>
ç”¨æ³•\uå­—èŠ‚ï¼šä¸ºäº†æé«˜æ•ˆç‡ï¼Œä¸å…¶ä»–å†…æ ¸ç»„ä»¶ä¸€æ ·ï¼Œå†…å­˜ç»„ä½¿ç”¨ä¸€äº›ä¼˜åŒ–<br>
é¿å…ä¸å¿…è¦çš„ç¼“å­˜çº¿é”™è¯¯å…±äº«ã€‚ä½¿ç”¨ç‡å—<br>
æ–¹æ³•ï¼Œä¸æ˜¾ç¤ºå†…å­˜ï¼ˆå’Œäº¤æ¢ï¼‰ä½¿ç”¨çš„â€œç²¾ç¡®â€å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡ç³Šçš„<br>
æœ‰æ•ˆè®¿é—®çš„å€¼ã€‚ï¼ˆå½“ç„¶ï¼Œå¿…è¦æ—¶ï¼Œå®ƒæ˜¯åŒæ­¥çš„ã€‚ï¼‰<br>
å¦‚æœæ‚¨æƒ³çŸ¥é“æ›´ç²¾ç¡®çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œåº”è¯¥ä½¿ç”¨rss+cacheï¼ˆ+swapï¼‰<br>
å†…å­˜ä¸­çš„å€¼ã€‚statï¼ˆè§5.2ï¼‰ã€‚<br>
è¯´ï¼š<br>
æ³¨æ„ï¼šåœ¨Linuxä¸Šï¼ŒDocker CLIé€šè¿‡ä»æ€»å†…å­˜ä½¿ç”¨é‡ä¸­å‡å»é¡µé¢ç¼“å­˜ä½¿ç”¨é‡æ¥æŠ¥å‘Šå†…å­˜ä½¿ç”¨æƒ…å†µã€‚APIä¸æ‰§è¡Œè¿™æ ·çš„è®¡ç®—ï¼Œè€Œæ˜¯æä¾›æ€»å†…å­˜ä½¿ç”¨é‡å’Œé¡µé¢ç¼“å­˜çš„æ•°é‡ï¼Œä»¥ä¾¿å®¢æˆ·æœºå¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨æ•°æ®ã€‚<br>
å®é™…ä¸Šï¼Œå®¹å™¨ä¸­/sys/fs/cgroup/memory/memory.statä¸­çš„å¤§å¤šæ•°å†…å®¹éƒ½å‡ºç°åœ¨ä¸Šé¢çš„docker stats apiå“åº”ä¸­ï¼ˆä¸åœ¨ä¸åŒæ—¶é—´é‡‡é›†æ ·æœ¬ç•¥æœ‰ä¸åŒï¼ŒæŠ±æ­‰ï¼‰ï¼š</p>
<pre><code>meme@myapp-56b947bf6d-2lcr7:/app# cat /sys/fs/cgroup/memory/memory.stat
cache 119492608
rss 607436800
rss_huge 0
shmem 5525504
mapped_file 1675264
dirty 69632
writeback 0
pgpgin 85573974
pgpgout 85396501
pgfault 296366011
pgmajfault 80
inactive_anon 1687552
active_anon 611213312
inactive_file 32800768
active_file 81166336
unevictable 0
hierarchical_memory_limit 5368709120
total_cache 119492608
total_rss 607436800
total_rss_huge 0
total_shmem 5525504
total_mapped_file 1675264
total_dirty 69632
total_writeback 0
total_pgpgin 85573974
total_pgpgout 85396501
total_pgfault 296366011
total_pgmajfault 80
total_inactive_anon 1687552
total_active_anon 611213312
total_inactive_file 32800768
total_active_file 81166336
total_unevictable 0
</code></pre>
<p>å†…å­˜ä¿¡æ¯æ¥è‡ªï¼š<br>
Limits:<br>
memory:  5Gi<br>
Requests:<br>
memory:   4Gi</p>
<p>ä¸‹é¢æ˜¯å®¹å™¨å†…çš„æç¤ºã€‚åœ¨è¿™ä¸€è¡Œç¨‹åºä¸­ï¼Œæˆ‘è·å–æ‰€æœ‰è¿›ç¨‹IDï¼Œåœ¨å®ƒä»¬ä¸Šè¿è¡Œpmap-xï¼Œå¹¶ä»pmapç»“æœä¸­æå–kbytesåˆ—ã€‚æ€»çš„ç»“æœæ˜¯256å…†å­—èŠ‚ï¼ˆè¿œå°äºPSçš„RSSï¼Œæˆ‘è®¤ä¸ºéƒ¨åˆ†åŸå› æ˜¯è®¸å¤šè¿›ç¨‹æ²¡æœ‰ä»PMAP-Xè¿”å›è¾“å‡ºï¼‰ï¼š</p>
<pre><code>ps aux | awk '{print $2}' | grep -v PID | xargs sudo pmap -x | grep total | grep -v grep | awk '{print $3}' | awk '{s+=$1} END {printf &quot;%.0f&quot;, s}'; echo
256820
</code></pre>
<p>https://github.com/google/cadvisor/issues/638ä¸­æåˆ°äº†ã€‚å®ƒæ£€æŸ¥kubectl describe pod <pod>å’Œpmapã€‚è¿™é‡Œæ²¡æœ‰ç…§æ˜ï¼ˆåŒæ ·ï¼Œå®ƒä¼¼ä¹å¿½ç•¥äº†ä¸€äº›è¿‡ç¨‹ï¼‰ï¼š</p>
<pre><code># python ps_mem.py
Private  +   Shared  =  RAM used    Program

  1.7 MiB +   1.0 MiB =   2.7 MiB   apache2
  2.0 MiB +   1.0 MiB =   3.0 MiB   bash (3)
---------------------------------
                          5.7 MiB
=================================
</code></pre>
<p>æœ€ä½³ç­”æ¡ˆ</p>
<pre><code>æœ‰ä¸€ä»¶äº‹æˆ‘æ²¡çœ‹åˆ°æ‚¨æ£€æŸ¥è¿™é‡Œæ˜¯å†…æ ¸å†…å­˜ã€‚è¿™åœ¨memory.usage_in_byteså›¾ä¸­ä¹Ÿæœ‰è¯´æ˜ï¼Œä½†åœ¨memory.statä¸­æ²¡æœ‰å‡ºç°ã€‚æ‚¨å¯ä»¥é€šè¿‡æŸ¥çœ‹/sys/fs/cgroup/memory/memory.kmem.usage_in_bytesæ‰¾åˆ°å®ƒã€‚
æœ‰ä¸€æ¬¡ï¼Œæˆ‘çœ‹åˆ°æˆ‘ä»¬çš„ä¸€ä¸ª.NETæ ¸å¿ƒåº”ç”¨ç¨‹åºä¹Ÿå‘ç”Ÿäº†ç±»ä¼¼çš„äº‹æƒ…ï¼Œä½†æˆ‘ä¸çŸ¥é“åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼ˆå¯èƒ½æ˜¯.NETæ ¸å¿ƒå†…å­˜æ³„æ¼ï¼Œå› ä¸ºå®ƒæ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ— æ³•æ§åˆ¶çš„éæ‰˜ç®¡å†…å­˜ï¼‰ã€‚è¿™å°†å–å†³äºæ‚¨çš„åº”ç”¨ç¨‹åºä½¿ç”¨æ˜¯å¦æ­£å¸¸ï¼Œä½†å°±cgroupsè€Œè¨€ï¼Œæˆ‘ç›¸ä¿¡å†…æ ¸å†…å­˜ä½¿ç”¨åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å—çº¦æŸçš„ã€‚
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[golangç¬”è®°-go modä¸go vendor]]></title>
        <id>http://lvelvis.github.io/post/golang-bi-ji-go-mod-yu-go-vendor/</id>
        <link href="http://lvelvis.github.io/post/golang-bi-ji-go-mod-yu-go-vendor/">
        </link>
        <updated>2020-06-10T08:40:20.000Z</updated>
        <content type="html"><![CDATA[<h1 id="go-mod-ä½¿ç”¨">go mod ä½¿ç”¨</h1>
<p>è§£å†³çš„é—®é¢˜æ˜¯golangä¸å†ä¾èµ–gopathçš„è®¾ç½®ï¼Œä¸‹è½½ä¸‹æ¥çš„åŒ…å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚<br>
go mod init ./<br>
go build main.go æˆ– go build -mod=vendor main.go<br>
go mod vendor #å°†åŒ…æ‰“åˆ°vendoræ–‡ä»¶å¤¹ä¸‹</p>
<h1 id="go-vendor">go vendor</h1>
<p>ç®¡ç†Golangé¡¹ç›®ä¾èµ–ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ï¼Œä½†æ˜¯æ¯”è¾ƒå¥½ç”¨ã€‚</p>
<p>å®‰è£…<br>
go get -u github.com/kardianos/govendor</p>
<p>ä½¿ç”¨ä¸€å¥—è¿æ‹›ï¼š</p>
<pre><code>govendor init # åˆ›å»ºvendorç›®å½•ï¼Œåˆ›å»ºvendor.jsonæ–‡ä»¶  
govendor add +external #ç”Ÿæˆä¾èµ–åŒ…  
govendor update +vendor # æ›´æ–°vendorçš„åŒ…å‘½ä»¤  
çŠ¶æ€	ç¼©å†™çŠ¶æ€	å«ä¹‰
+local	l	æœ¬åœ°åŒ…ï¼Œå³é¡¹ç›®è‡ªèº«çš„åŒ…ç»„ç»‡
+external	e	å¤–éƒ¨åŒ…ï¼Œå³è¢« $GOPATH ç®¡ç†ï¼Œä½†ä¸åœ¨ vendor ç›®å½•ä¸‹
+vendor	v	å·²è¢« govendor ç®¡ç†ï¼Œå³åœ¨ vendor ç›®å½•ä¸‹
+std	s	æ ‡å‡†åº“ä¸­çš„åŒ…
+unused	u	æœªä½¿ç”¨çš„åŒ…ï¼Œå³åŒ…åœ¨ vendor ç›®å½•ä¸‹ï¼Œä½†é¡¹ç›®å¹¶æ²¡æœ‰ç”¨åˆ°
+missing	m	ä»£ç å¼•ç”¨äº†ä¾èµ–åŒ…ï¼Œä½†è¯¥åŒ…å¹¶æ²¡æœ‰æ‰¾åˆ°
+program	p	ä¸»ç¨‹åºåŒ…ï¼Œæ„å‘³ç€å¯ä»¥ç¼–è¯‘ä¸ºæ‰§è¡Œæ–‡ä»¶
+outside	 	å¤–éƒ¨åŒ…å’Œç¼ºå¤±çš„åŒ…
+all	 	æ‰€æœ‰çš„åŒ…
å‘½ä»¤	åŠŸèƒ½
init	åˆå§‹åŒ– vendor ç›®å½•
list	åˆ—å‡ºæ‰€æœ‰çš„ä¾èµ–åŒ…
add	æ·»åŠ åŒ…åˆ° vendor ç›®å½•ï¼Œå¦‚ govendor add +external æ·»åŠ æ‰€æœ‰å¤–éƒ¨åŒ…
add PKG_PATH	æ·»åŠ æŒ‡å®šçš„ä¾èµ–åŒ…åˆ° vendor ç›®å½•
update	ä» $GOPATH æ›´æ–°ä¾èµ–åŒ…åˆ° vendor ç›®å½•
remove	ä» vendor ç®¡ç†ä¸­åˆ é™¤ä¾èµ–
status	åˆ—å‡ºæ‰€æœ‰ç¼ºå¤±ã€è¿‡æœŸå’Œä¿®æ”¹è¿‡çš„åŒ…
fetch	æ·»åŠ æˆ–æ›´æ–°åŒ…åˆ°æœ¬åœ° vendor ç›®å½•
sync	æœ¬åœ°å­˜åœ¨ vendor.json æ—¶å€™æ‹‰å»ä¾èµ–åŒ…ï¼ŒåŒ¹é…æ‰€è®°å½•çš„ç‰ˆæœ¬
get	ç±»ä¼¼ go get ç›®å½•ï¼Œæ‹‰å–ä¾èµ–åŒ…åˆ° vendor ç›®å½•
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[golangç¬”è®°-zipæ—¥å¿—ä½¿ç”¨]]></title>
        <id>http://lvelvis.github.io/post/golang-bi-ji-zip-ri-zhi-shi-yong/</id>
        <link href="http://lvelvis.github.io/post/golang-bi-ji-zip-ri-zhi-shi-yong/">
        </link>
        <updated>2020-06-03T06:17:23.000Z</updated>
        <content type="html"><![CDATA[<p>åœ¨beegoä¸­ä½¿ç”¨zapç®¡ç†æ—¥å¿—ï¼Œå¾ˆæ–¹ä¾¿ğŸ‘<br>
éœ€è¦åœ¨conf/app.confå®šä¹‰å‡ ä¸ªå‚æ•°</p>
<pre><code>appname = web-terminal
httpport = &quot;9600&quot;

runmode = &quot;prod&quot;
LogLevel = &quot;info&quot;
autorender = true
recoverpanic = false
copyrequestbody = true
viewspath = &quot;static&quot;
LogPath = &quot;logs/k8s-websocket.log&quot;
</code></pre>
<p>logger.go</p>
<pre><code>package controllers

import (
	&quot;os&quot;

	&quot;github.com/astaxie/beego&quot;
	&quot;github.com/natefinch/lumberjack&quot;
	&quot;go.uber.org/zap&quot;
	&quot;go.uber.org/zap/zapcore&quot;
)

//MyLoggeråˆå§‹åŒ–zaploggeræ—¥å¿—åº“
var MyLogger *zap.Logger

func initLogger(logpath string, loglevel string) *zap.Logger {

	// è®¾ç½®æ—¥å¿—çº§åˆ«
	var level zapcore.Level
	switch loglevel {
	case &quot;debug&quot;:
		level = zap.DebugLevel
	case &quot;info&quot;:
		level = zap.InfoLevel
	case &quot;error&quot;:
		level = zap.ErrorLevel
	default:
		level = zap.InfoLevel
	}

	hook := lumberjack.Logger{
		Filename:   logpath, // æ—¥å¿—æ–‡ä»¶è·¯å¾„
		MaxSize:    20,      // æ¯ä¸ªæ—¥å¿—æ–‡ä»¶ä¿å­˜çš„æœ€å¤§å°ºå¯¸ å•ä½ï¼šM
		MaxBackups: 10,      // æ—¥å¿—æ–‡ä»¶æœ€å¤šä¿å­˜å¤šå°‘ä¸ªå¤‡ä»½
		MaxAge:     7,       // æ–‡ä»¶æœ€å¤šä¿å­˜å¤šå°‘å¤©
		Compress:   true,    // æ˜¯å¦å‹ç¼©
	}

	encoderConfig := zapcore.EncoderConfig{
		TimeKey:        &quot;time&quot;,
		LevelKey:       &quot;level&quot;,
		NameKey:        &quot;logger&quot;,
		CallerKey:      &quot;linenum&quot;,
		MessageKey:     &quot;msg&quot;,
		StacktraceKey:  &quot;stacktrace&quot;,
		LineEnding:     zapcore.DefaultLineEnding,
		EncodeLevel:    zapcore.LowercaseLevelEncoder,  // å°å†™ç¼–ç å™¨
		EncodeTime:     zapcore.ISO8601TimeEncoder,     // ISO8601 UTC æ—¶é—´æ ¼å¼
		EncodeDuration: zapcore.SecondsDurationEncoder, //
		EncodeCaller:   zapcore.ShortCallerEncoder,     // çŸ­è·¯å¾„ç¼–ç å™¨
		EncodeName:     zapcore.FullNameEncoder,
	}

	core := zapcore.NewCore(
		zapcore.NewJSONEncoder(encoderConfig),                                           // ç¼–ç å™¨é…ç½®
		zapcore.NewMultiWriteSyncer(zapcore.AddSync(os.Stdout), zapcore.AddSync(&amp;hook)), // æ‰“å°åˆ°æ§åˆ¶å°å’Œæ–‡ä»¶
		level, // æ—¥å¿—çº§åˆ«
	)

	// å¼€å¯å¼€å‘æ¨¡å¼ï¼Œå †æ ˆè·Ÿè¸ª
	caller := zap.AddCaller()
	// å¼€å¯æ–‡ä»¶åŠè¡Œå·
	development := zap.Development()

	// è®¾ç½®åˆå§‹åŒ–å­—æ®µ
	filed := zap.Fields(zap.String(&quot;serviceName&quot;, &quot;k8s-websocket-dashboard&quot;))
	// æ„é€ æ—¥å¿—
	logger := zap.New(core, caller, development, filed)

	logger.Info(&quot;initlog åˆå§‹åŒ–æˆåŠŸ&quot;)
	return logger
}

// åˆå§‹åŒ–æ—¥å¿—
func init() {
	logPath := beego.AppConfig.String(&quot;LogPath&quot;)
	loglevel := beego.AppConfig.String(&quot;LogLevel&quot;)
	MyLogger = initLogger(logPath, loglevel)
}
</code></pre>
<p>æ—¥å¿—è¾“å‡ºï¼š</p>
<pre><code>{&quot;level&quot;:&quot;info&quot;,&quot;time&quot;:&quot;2020-06-02T19:41:37.799+0800&quot;,&quot;linenum&quot;:&quot;controllers/logger.go:59&quot;,&quot;msg&quot;:&quot;log åˆå§‹åŒ–æˆåŠŸ&quot;,&quot;serviceName&quot;:&quot;k8s-websocket-dashboard&quot;}
</code></pre>
]]></content>
    </entry>
</feed>